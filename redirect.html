<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Product Offers</title>
  <style>
    body {
      margin: 0;
      padding: 0;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: #f9f9f9;
      color: #333;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
    }

    header {
      background-color: #4a90e2;
      color: white;
      padding: 1rem;
      text-align: center;
      font-size: 1.5rem;
      font-weight: 600;
    }

    .container {
      padding: 1rem;
      max-width: 700px;
      margin: auto;
      flex: 1;
      width: 100%;
      box-sizing: border-box;
    }

    .product {
      background-color: #fff;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.06);
      padding: 1.5rem;
      margin-bottom: 1rem;
      display: flex;
      align-items: center;
      gap: 1rem;
      transition: transform 0.2s ease, box-shadow 0.2s ease;
    }

    .product:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 16px rgba(0,0,0,0.1);
    }

    .product-thumb img {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      object-fit: cover;
    }

    .product-details {
      flex: 1;
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
    }

    .product-name {
      font-size: 1.1rem;
      font-weight: 600;
      color: #222;
      line-height: 1.4;
    }

    .product-price {
      font-size: 1rem;
      font-weight: 600;
      color: #e74c3c;
    }

    .product-links {
      display: flex;
      gap: 0.75rem;
      flex-wrap: wrap;
    }

    .product-links a {
      padding: 0.6rem 1rem;
      text-decoration: none;
      border-radius: 8px;
      font-weight: 500;
      color: white;
      font-size: 0.95rem;
      transition: all 0.3s ease;
      text-align: center;
      flex: 1;
      min-width: 140px;
      border: none;
      cursor: pointer;
    }

    .product-links a[href*="amazon"] {
      background-color: #ff9900;
    }

    .product-links a[href*="meesho"] {
      background-color: #8a2be2;
    }

    .product-links a:hover {
      opacity: 0.9;
      transform: translateY(-1px);
    }

    .message {
      text-align: center;
      font-size: 1.1rem;
      color: #666;
      margin-top: 2rem;
    }

    .disclaimer {
      background-color: #fff8e1;
      border-left: 4px solid #ffc107;
      padding: 1rem;
      margin-top: 2rem;
      font-size: 0.9rem;
      color: #666;
      border-radius: 4px;
    }

    .loading {
      text-align: center;
      padding: 2rem;
    }

    .spinner {
      border: 4px solid #f3f3f3;
      border-top: 4px solid #4a90e2;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
      margin: 0 auto 1rem;
    }

    @keyframes spin {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    @media (max-width: 600px) {
      .product {
        flex-direction: column;
        text-align: center;
        padding: 1rem;
      }
      
      .product-links a {
        min-width: 120px;
      }
      
      .container {
        padding: 0.5rem;
      }
    }
  </style>
</head>
<body>
  <header>üéÅ Available at These Stores</header>
  <div class="container">
    <div id="productList">
      <div class="loading">
        <div class="spinner"></div>
        <div>Loading products...</div>
      </div>
    </div>
    <div id="disclaimer" class="disclaimer" style="display: none;"></div>
    <div id="errorLog" class="disclaimer" style="display: none; background-color: #ffebee; border-left: 4px solid #f44336; margin-top: 20px; white-space: pre-wrap; font-family: monospace; font-size: 12px;"></div>
  </div>

  <script>
    const productId = new URLSearchParams(location.search).get("v");
    const productList = document.getElementById("productList");
    const disclaimerEl = document.getElementById("disclaimer");
    const errorLogEl = document.getElementById("errorLog");
    const DEBUG = true;

    if (DEBUG) {
      errorLogEl.style.display = 'block';
    }

    // Debug information
    errorLogEl.innerHTML = `<strong>Debug Information:</strong>
Product ID: ${productId || 'NONE'}
Current URL: ${window.location.href}
Script URL: ${document.currentScript.src}
Time: ${new Date().toISOString()}`;

    // Replace with your actual Google Apps Script Web App URL
    const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbxNGOPrEo54Lwf45CXdfNvxHsdNrR6gT2ZTY5Hl0w/dev"; // IMPORTANT: Replace this with your actual main.txt script's deployed web app URL

    function redirectTo(url) {
      if (url && isValidUrl(url)) {
        window.location.href = url;
      }
    }

    function isValidUrl(string) {
      try {
        new URL(string);
        return true;
      } catch (_) {
        return false;
      }
    }

    // Helper function to safely access nested object properties
    function getSafe(obj, path, defaultValue = null) {
      return path.split('.').reduce((acc, key) => {
        return acc && acc[key] !== undefined ? acc[key] : defaultValue;
      }, obj);
    }

    function displayProducts(data) {
      console.log('Received data:', data); // Debug log
      
      if (!data || !Array.isArray(data.products) || data.products.length === 0) {
        productList.innerHTML = '<div class="message">No products found.</div>';
        return;
      }

      let html = '';
      
      data.products.forEach((product, index) => {
        if (!product) return;
        
        console.log('Processing product:', product); // Debug log
        
        const hasAmazon = isValidUrl(product.amazonIND);
        const hasMeesho = isValidUrl(product.meesho);
        
        if (!hasAmazon && !hasMeesho) return;

        // Safely extract product data
        const productName = getSafe(product, 'ItemInfo.Title.DisplayValue') || 
                           product.productName || 
                           "Best Offer";
        
        const thumbnail = getSafe(product, 'Images.Primary.Medium.URL') || 
                         product.thumbnail;
        
        const price = getSafe(product, 'Offers.Listings.0.Price.DisplayAmount') || 
                     product.price;

        if (DEBUG) {
          errorLogEl.innerHTML += `\n\nProduct ${index} parsed: ${JSON.stringify({
            productId: product.productId,
            productName,
            amazonIND: product.amazonIND,
            meesho: product.meesho,
            thumbnail,
            price,
            hasAmazon,
            hasMeesho
          }, null, 2)}`;
        }

        html += `
          <div class="product">
            ${thumbnail ? `
              <div class="product-thumb">
                <img src="${thumbnail}" alt="${productName}" onerror="this.style.display='none'">
              </div>
            ` : ''}
            <div class="product-details">
              <div class="product-name">${productName}</div>
              ${price ? `<div class="product-price">${price}</div>` : ''}
              <div class="product-links">
                ${hasAmazon ? `
                  <a href="${product.amazonIND}" onclick="trackClick('${product.productId}', 'amazon')" target="_blank">
                    üõí Buy on Amazon
                  </a>
                ` : ''}
                ${hasMeesho ? `
                  <a href="${product.meesho}" onclick="trackClick('${product.productId}', 'meesho')" target="_blank">
                    üõç Buy on Meesho
                  </a>
                ` : ''}
              </div>
            </div>
          </div>
        `;
      });

      if (html === '') {
        productList.innerHTML = '<div class="message">No valid links found.</div>';
        return;
      }

      productList.innerHTML = html;
      
      // Display disclaimer
      if (data.disclaimer) {
        disclaimerEl.textContent = data.disclaimer;
        disclaimerEl.style.display = 'block';
      }
    }

    function trackClick(productId, platform) {
      // Add analytics tracking here if needed
      console.log(`Clicked ${platform} for product ${productId}`);
    }

    if (!productId) {
      productList.innerHTML = '<div class="message">Invalid product ID.</div>';
      errorLogEl.innerHTML += `\n\nNo product ID provided in URL`;
    } else {
      const requestUrl = `${SCRIPT_URL}?v=${encodeURIComponent(productId)}`;
      errorLogEl.innerHTML += `\n\nFetching data from: ${requestUrl}`;
      
      fetch(requestUrl)
        .then(res => {
          errorLogEl.innerHTML += `\n\nResponse status: ${res.status} ${res.statusText}`;
          if (!res.ok) {
            throw new Error(`Network response was not ok: ${res.status} ${res.statusText}`);
          }
          return res.json();
        })
        .then(data => {
          errorLogEl.innerHTML += `\n\nReceived data: ${JSON.stringify(data, null, 2).substring(0, 500)}...`;
          displayProducts(data);
        })
        .catch(err => {
          const errorMessage = err.toString();
          errorLogEl.innerHTML += `\n\nFetch error: ${errorMessage}`;
          productList.innerHTML = `<div class="message">Error loading products: ${errorMessage}</div>`;
        });
    }
  </script>
</body>
</html>
